var key=CT.getVal("mapkey");CT.scriptImport("https://maps.googleapis.com/maps/api/js"+(key?"?key="+key:""));window.CT=window.CT||{};window.CT.map=window.CT.map||{};window.CT.map.util=window.CT.map.util||{};CT.map.util={_try_limit:20,_llcache:CT.storage.get("addr2latlng")||{},_keys:[],_kindex:0,_get_res:function(a){var b={address:a},c=CT.map.util._keys[CT.map.util._kindex];if(c){b.key=c;CT.map.util._kindex+=1;}else CT.map.util._kindex=0;return CT.net.get("https://maps.googleapis.com/maps/api/geocode/json",b,true).results[0];},_try_a2ll:function(a){var b=0,c,d;while(b<CT.map.util._try_limit&&!c){c=CT.map.util._get_res(a);if(c)return c;b+=1;CT.log("CT.map.util.addr2latlng: can't find "+a+" - trying again! tries: "+b);}},_geo_fallback:{lat:37.75,lng:-122.45},setGeoKeys:function(a){CT.map.util._keys=a;},setGeoFallback:function(a){CT.map.util._geo_fallback=a;},getGeoFallback:function(){return CT.map.util._geo_fallback;},icon:function(a,b){if(a&&typeof a=="string"){var c=b.getIcon();if(c&&c.url)return CT.merge({url:a},c);}return a;},latlng:function(a){return a instanceof google.maps.LatLng?a:new google.maps.LatLng(a);},addr2latlng:function(a){var b=CT.map.util._llcache;if(!b[a]){b[a]=CT.map.util._try_a2ll(a).geometry.location;CT.storage.set("addr2latlng",b);}return b[a];},ips2latlngs:function(a,b){CT.net.post({path:location.protocol+"//api.mkult.co/geo",params:{action:"ips",ips:a},cb:b});},bounds:function(a,b){return new google.maps.LatLngBounds(CT.map.util.latlng(a),CT.map.util.latlng(b));}};;window.CT.map.Map=window.CT.map.Map||{};CT.map.Map=CT.Class({CLASSNAME:"CT.map.Map",markers:{},addTriggers:function(a,b,c,d,e){var f=this.addMarker;e=e||CT.dom.id("map"+b+"s");d&&e.appendChild(CT.panel.trigger({"title":"new "+b},d));CT.panel.triggerList(a.map(function(a){d=c(a);d.key=a.key;d.marker=f(d);return d;}),function(a){a.marker.showInfo();},e);},setMarker:function(a){this.addMarker(a).update(a);},addMarker:function(a){var b=this.markers[a.key]=this.markers[a.key]||new CT.map.Marker(a);if(this.map)b.add(this.map);else this.opts.markers[a.key]=a;return b;},addMarkers:function(a){var b=this,c=[];a.forEach(function(a){c.push(b.addMarker(a));});return c;},resizeMarkers:function(a,b){for(var c in this.markers)this.markers[c].resize(a,b);},clearMarkers:function(a){(Array.isArray(a)?a:Object.values(this.markers)).forEach(function(a){a.remove();});},getMarker:function(a){return this.markers[a];},removeMarker:function(a){var b=this.getMarker(a);if(b)b.remove();else this.log("removeMarker(): can't find key '"+a+"'");},geoJson:function(a){this.map.data.loadGeoJSON(a);},frame:function(a,b){var c=a.getPosition(),d=b.getPosition();this.map.fitBounds(CT.map.util.bounds({latitude:Math.min(c.lat(),d.lat()),longitude:Math.min(c.lng(),d.lng())},{latitude:Math.max(c.lat(),d.lat()),longitude:Math.max(c.lng(),d.lng())}));},_build:function(){var a;this.opts.center=CT.map.util.latlng(this.opts.center);this.map=new google.maps.Map(this.opts.node,this.opts);for(a in this.opts.markers)this.addMarker(this.opts.markers[a]);if(this.opts.geojson)this.geoJson(this.opts.geojson);this.refresh();this.map.setCenter(this.opts.center);for(a in this.opts.listeners)this.listen(a,this.opts.listeners[a]);this.opts.onload&&this.opts.onload();},setCenter:function(a){this.map.setCenter(a);},panTo:function(a){this.map.panTo(a);},refresh:function(){google.maps.event.trigger(this.map,'resize');},_geoSucceed:function(a){this.opts.center={lat:a.coords.latitude,lng:a.coords.longitude};this._build();},_geoFail:function(){this.opts.center=CT.map.util.getGeoFallback();this._build();},listen:function(a,b){google.maps.event.addListener(this.map,a,b);},init:function(a){this.opts=a=CT.merge(a,{zoom:12,disableDefaultUI:true,zoomControl:true,markers:{},listeners:{}});if(a.center)this._build();else navigator.geolocation.getCurrentPosition(this._geoSucceed,this._geoFail);}});;window.CT.map.Node=window.CT.map.Node||{};CT.map.Node=CT.Class({CLASSNAME:"CT.map.Node",_regEvt:function(a){if(this.opts.listeners[a])google.maps.event.addDomListener(this.content,a,this.opts.listeners[a]);},_add:function(){this.content=CT.dom.node(this.opts.content,"div",this.opts.className);this.projection=this.overlay.getProjection();CT.dom.setContent(this.overlay.getPanes().floatPane,this.content);Object.keys(this.opts.listeners).forEach(this._regEvt);},_remove:function(){google.maps.event.clearListeners(this.content);CT.dom.remove(this.content);this.content=null;},_draw:function(){if(!this.content||!this.opts.visible)return;var a=this.projection.fromLatLngToDivPixel(this.opts.position);this.content.style.left=a.x+"px";this.content.style.top=a.y+"px";},getPosition:function(){return this.opts.position;},setPosition:function(a){this.opts.position=a;this._draw();},setVisible:function(a){this.opts.visible=a;if(this.content){this.content.style.display=a?"block":"none";this._draw();}},setContent:function(a){this.opts.content=a;if(this.content)CT.dom.setContent(this.content,a);},setListeners:function(a){this.opts.listeners=a;if(this.content){google.maps.event.clearListeners(this.content);Object.keys(a).forEach(this._regEvt);}},clearListeners:function(){this.setListeners({});},addListener:function(a,b){this.opts.listeners[a]=b;this._regEvt(a);},addUpdater:function(a,b){this.opts.updaters[a]=b;},update:function(a){var b=this.opts=CT.merge(a,this.opts);if("visible" in a)this.setVisible(a.visible);if(a.position)this.setPosition(a.position);if(a.content)this.setContent(a.content);if(a.listeners)this.setListeners(a.listeners);Object.keys(b.updaters).forEach(function(c){if(c in a)b.updaters[c](a[c]);});},show:function(){this.overlay.setMap(this.opts.map);},hide:function(){this.overlay.setMap(null);},init:function(a){this.opts=a=CT.merge(a,{visible:true,updaters:{},listeners:{}});this.overlay=new google.maps.OverlayView();this.overlay.onAdd=this._add;this.overlay.onRemove=this._remove;this.overlay.draw=this._draw;}});;window.CT.map.Marker=window.CT.map.Marker||{};CT.map.DOMMarker=CT.Class({CLASSNAME:"CT.map.DOMMarker",setTitle:function(a){this.opts.title=a;if(this.title)this.title.setContent(a);else this._build();},setIcon:function(a){if(typeof a=="string")a=CT.dom.img(a);this.setContent(a);},setMap:function(a){this.opts.map=a;this.overlay.setMap(a);},_build:function(){if(this.opts.title)this.title=new CT.map.Node(CT.merge(this.opts.hover,{map:this.opts.map,content:this.opts.title,position:this.getPosition(),className:"tooltip"}));},init:function(){this.opts=CT.merge(this.opts,{className:"abs pointer"});this.addUpdater("map",this.setMap);this.addUpdater("icon",this.setIcon);this.addUpdater("title",this.setTitle);this._build();}},CT.map.Node);CT.map.infoWindow=function(){return new google.maps.InfoWindow();};CT.map.infoWindowSingleton=function(){if(!CT.map._iw)CT.map._iw=CT.map.infoWindow();return CT.map._iw;};CT.map.useSingleInfoWindow=function(){CT.map._iwSingleton=true;};CT.map.Marker=CT.Class({CLASSNAME:"CT.map.Marker",_wrappers:["title","icon","map","content","position","visible"],_converters:{position:CT.map.util.latlng,icon:CT.map.util.icon},add:function(a){this.opts.map=a;this.marker.setMap(a);},remove:function(){this.opts.map=null;this.marker.setMap(null);this.hideInfo();},update:function(a){var b=this;this.opts=CT.merge(a,this.opts);this._wrappers.forEach(function(a){if(a in b.opts)b["set"+CT.parse.capitalize(a)](b.opts[a]);});},resize:function(a,b){b=b||a;this.setIcon(CT.merge({size:new google.maps.Size(a,b)},this.getIcon()));},_showInfo:function(){this.cancelInfo();var a=this._infoWindow=this._infoWindow||CT.map.infoWindow();a.setContent(this.opts.info);a.setPosition(this.getPosition());a.open(this.opts.map);},showInfo:function(){if(this.opts.infoDelay){if(!this._infoTimeout)this._infoTimeout=setTimeout(this._showInfo,this.opts.infoDelay);}else this._showInfo();},cancelInfo:function(){if(this._infoTimeout){clearTimeout(this._infoTimeout);delete this._infoTimeout;}},hideInfo:function(){this._infoWindow&&this._infoWindow.close();},_wrap:function(a){var b=this,c=CT.parse.capitalize(a);this["get"+c]=function(){return b.opts[a];};this["set"+c]=function(d){b.opts[a]=b._converters[a]?b._converters[a](d,b):d;b.marker["set"+c](b.opts[a]);};},_buildWrappers:function(){this._wrappers.forEach(this._wrap);},_addMarkerListener:function(a,b){google.maps.event.addListener(this.marker,a,b);},_buildMarker:function(){this.marker=new google.maps.Marker(this.opts);for(var a in this.opts.listeners)this._addMarkerListener(a,this.opts.listeners[a]);},_buildCustomMarker:function(){this.marker=new CT.map.DOMMarker(this.opts);},init:function(a){this.opts=a=CT.merge(a,{icon:"http://maps.google.com/mapfiles/ms/icons/purple-dot.png"});if(a.info)a.listeners=CT.merge(a.listeners,{click:this.showInfo});a.position=CT.map.util.latlng((a.position&&a.position.lat&&a.position.lng)?a.position:CT.map.util.addr2latlng(a.address));a.content?this._buildCustomMarker():this._buildMarker();if(CT.map._iwSingleton)this._infoWindow=CT.map.infoWindowSingleton();this._buildWrappers();if(this.opts.map)this.add(this.opts.map);}});;window.CT.map.Shape=window.CT.map.Shape||{};CT.map.Shape=CT.Class({CLASSNAME:"CT.map.Shape",_gclass:function(){var a=this.CLASSNAME.split(".")[2];return{Shape:"Polygon",Line:"Polyline"}[a]||a;},add:function(a){this.opts.map=a;this.shape.setMap(a);},remove:function(){this.opts.map=null;this.shape.setMap(null);},init:function(a){this.opts=a;this.shape=new google.maps[this._gclass()](a);if(a.map)this.add(a.map);}});CT.map.Circle=CT.Class({CLASSNAME:"CT.map.Circle"},CT.map.Shape);CT.map.Rectangle=CT.Class({CLASSNAME:"CT.map.Rectangle"},CT.map.Shape);CT.map.Line=CT.Class({CLASSNAME:"CT.map.Line"},CT.map.Shape);;;